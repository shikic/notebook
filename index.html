<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>思绪记录</title>
    <!-- 引入 Tailwind CSS CDN --><script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 自定义 Tailwind 配置，定义北欧风格配色和字体 */
        :root {
            /* 浅色、中性、柔和 */
            --color-light-bg: #f7f9fa;
            --color-primary-text: #334155;
            --color-accent: #81A1C1; /* 柔和的北欧蓝/灰蓝 */
            --color-card-bg: #ffffff;
            --color-border: #e2e8f0;
            --color-text-light: #f7f9fa; /* 用于深色背景上的文字/SVG */
            --color-text-dark: #334155; /* 用于浅色背景上的文字/SVG */
        }

        /* 使用 Inter 字体 */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-light-bg);
            color: var(--color-primary-text);
            min-height: 100vh;
        }

        /* 覆盖默认按钮焦点样式 */
        button:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(129, 161, 193, 0.5); /* 柔和的蓝色焦点环 */
        }

        /* 自定义头像样式 */
        .avatar-option {
            width: 48px; /* 稍大一点方便点击 */
            height: 48px;
            cursor: pointer;
            transition: transform 0.1s ease-in-out, box-shadow 0.1s ease-in-out;
            color: var(--color-text-light); /* SVG 颜色默认为浅色 */
            padding: 8px; /* 增加内边距让 SVG 居中 */
        }
        .avatar-option:hover {
            transform: scale(1.1);
            box-shadow: 0 0 0 4px rgba(129, 161, 193, 0.5);
        }
        .avatar-option.selected {
            box-shadow: 0 0 0 3px var(--color-accent);
        }

        /* 确保 SVG 在容器内填满并居中 */
        .avatar-svg svg {
            width: 100%;
            height: 100%;
            display: block;
        }

        /* 为浅色背景头像设置深色SVG */
        /* 根据新的头像颜色调整，可能需要为其他浅色背景头像设置深色SVG */
        .avatar-option[data-id="robin"] { color: var(--color-text-dark); } /* 燕雀 */
        .avatar-option[data-id="swallow"] { color: var(--color-text-dark); } /* 燕子 */
    </style>
</head>
<body class="p-4 sm:p-8 flex justify-center">

    <!-- 
        口令保护层 (Passcode Overlay) - 默认显示 
        正确的口令是: 9793
    --><div id="passcode-overlay" class="fixed inset-0 z-50 flex items-center justify-center bg-gray-100 transition-opacity duration-300">
        <div class="bg-white p-8 sm:p-10 rounded-xl shadow-2xl w-full max-w-sm text-center">
            <h2 class="text-2xl font-light mb-6 text-gray-700">请输入口令</h2>
            <input
                type="password"
                id="passcode-input"
                placeholder="在此输入口令"
                class="w-full p-3 border border-gray-300 rounded-lg text-center focus:ring-2 focus:ring-blue-300 focus:border-blue-300 transition duration-150 ease-in-out"
                onkeypress="if(event.key === 'Enter') checkPasscode()"
            >
            <p id="passcode-error" class="text-red-500 text-sm mt-2 opacity-0 transition duration-300">口令错误，请重试。</p>
            <button
                onclick="checkPasscode()"
                class="mt-6 w-full px-6 py-3 rounded-lg text-white font-medium transition duration-200 ease-in-out hover:opacity-90 shadow-md"
                style="background-color: var(--color-accent);"
            >
                进入想法集
            </button>
            <!-- 提示已移除 --></div>
    </div>

    <!-- Avatar Selection Modal (头像选择模态框) --><div id="avatar-modal" class="hidden fixed inset-0 z-[60] flex items-center justify-center bg-black bg-opacity-40 transition-opacity duration-300">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
            <h3 class="text-xl font-medium mb-6 text-gray-700">选择你的像素鸟</h3>
            <div id="avatar-options-grid" class="grid grid-cols-4 gap-4">
                <!-- 头像选项将由 JS 渲染到此处 --></div>
            <button onclick="hideAvatarModal()" class="mt-8 w-full px-6 py-3 rounded-lg text-white font-medium transition duration-200 ease-in-out hover:opacity-90 shadow-md" style="background-color: var(--color-accent);">
                确定
            </button>
        </div>
    </div>


    <!-- 主内容区域 - 默认隐藏，口令正确后显示 --><div id="main-content" class="hidden w-full max-w-4xl">
        <!-- Header: 标题和描述 --><header class="text-center py-10 sm:py-16">
            <h1 class="4xl sm:text-5xl font-light text-gray-700 tracking-wider">
                思绪集 
            </h1>
            <!-- 已移除副标题 --></header>

        <!-- Input Section: 想法输入区域 --><section id="input-section" class="bg-white p-6 sm:p-8 rounded-xl shadow-lg border border-gray-100 mb-10">
            <!-- Avatar Selection Section --><div id="avatar-selection-section" class="flex items-center space-x-4 mb-6 p-2 border-b border-gray-100">
                <h2 class="text-lg font-medium text-gray-700">当前记录人：</h2>
                <div 
                    id="current-avatar" 
                    class="avatar-svg w-10 h-10 rounded-full flex items-center justify-center text-white text-xl font-semibold cursor-pointer ring-2 ring-offset-2 hover:ring-blue-400 transition p-2" 
                    onclick="showAvatarModal()"
                    title="点击更改头像"
                    style="color: var(--color-text-light);"
                >
                    <!-- Avatar SVG will be inserted here --></div>
            </div>

            <h2 class="text-xl font-medium mb-4">记录新的想法</h2>
            <textarea
                id="thought-input"
                placeholder="在此处写下您的想法，保持简洁..."
                class="w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-300 focus:border-blue-300 transition duration-150 ease-in-out"
                rows="4"
            ></textarea>
            
            <!-- NEW TAG INPUT: 标签输入框 (连接到 datalist) --><input
                type="text"
                id="tag-input"
                placeholder="添加标签 (例如: 灵感, 工作, 思考，用逗号分隔)"
                class="w-full p-3 mt-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-300 focus:border-blue-300 transition duration-150 ease-in-out"
                list="default-tags"
            >
            <!-- DATALIST: 默认标签建议列表 --><datalist id="default-tags">
                <!-- 由 JS 填充 --></datalist>

            <button
                id="add-button"
                onclick="addThought()"
                class="mt-4 px-6 py-2 rounded-lg text-white font-medium transition duration-200 ease-in-out hover:opacity-90 shadow-md"
                style="background-color: var(--color-accent);"
            >
                添加记录
            </button>
        </section>

        <!-- Tag Filter Section: 标签筛选区域 --><section class="mb-8">
            <h2 class="text-xl font-medium mb-3">标签筛选</h2>
            <div id="tag-cloud" class="flex flex-wrap gap-2">
                <!-- 标签云将由 JavaScript 渲染到此处 --></div>
        </section>

        <!-- Thoughts Display Section: 已记录想法列表 --><section>
            <!-- NEW ID: thoughts-title 用于动态显示分类 --><h2 id="thoughts-title" class="text-2xl font-medium mb-6">已保存的思绪</h2>
            <div id="thoughts-list" class="space-y-4">
                <!-- 想法将由 JavaScript 渲染到此处 --></div>
        </section>
    </div>

    <script>
        // JavaScript 核心逻辑
        const STORAGE_KEY = 'nordic_thoughts_journal_v2';
        const AVATAR_KEY = 'nordic_user_avatar_id';

        const thoughtsListEl = document.getElementById('thoughts-list');
        const thoughtInputEl = document.getElementById('thought-input');
        const tagInputEl = document.getElementById('tag-input');
        const tagCloudEl = document.getElementById('tag-cloud');
        const thoughtsTitleEl = document.getElementById('thoughts-title'); 
        const defaultTagsDatalistEl = document.getElementById('default-tags');
        
        // Avatar elements
        const currentAvatarEl = document.getElementById('current-avatar');
        const avatarModalEl = document.getElementById('avatar-modal');
        const avatarOptionsGridEl = document.getElementById('avatar-options-grid');
        
        // Passcode elements
        const passcodeOverlayEl = document.getElementById('passcode-overlay');
        const mainContentEl = document.getElementById('main-content');
        const passcodeErrorEl = document.getElementById('passcode-error');
        const passcodeInputEl = document.getElementById('passcode-input');
        
        // 硬编码口令 (已更新为 9793)
        const CORRECT_PASSCODE = '9793'; 
        
        let currentFilterTag = null; // 追踪当前的筛选标签
        
        // 默认标签列表
        const DEFAULT_TAGS = ["灵感", "工作", "思考", "待办", "学习"]; 

        // 头像选项 - 像素风格的鸟类，使用嵌入式 SVG
        const AVATAR_OPTIONS = [
            // 像素知更鸟 (Robin)
            { id: 'robin', name: '知更鸟', color: '#EBCB8B', svg: '<svg viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><rect x="6" y="2" width="2" height="2"/><rect x="8" y="3" width="2" height="2"/><rect x="5" y="4" width="6" height="4"/><rect x="4" y="8" width="8" height="3"/><rect x="5" y="11" width="2" height="2"/><rect x="9" y="11" width="2" height="2"/><rect x="7" y="5" width="1" height="1"/><rect x="10" y="6" width="1" height="1"/></svg>' },
            // 像素蓝鸟 (Bluebird)
            { id: 'bluebird', name: '蓝鸟', color: '#81A1C1', svg: '<svg viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><rect x="6" y="2" width="2" height="2"/><rect x="8" y="3" width="2" height="2"/><rect x="5" y="4" width="6" height="4"/><rect x="4" y="8" width="8" height="3"/><rect x="5" y="11" width="2" height="2"/><rect x="9" y="11" width="2" height="2"/><rect x="7" y="5" width="1" height="1"/><rect x="10" y="6" width="1" height="1"/></svg>' },
            // 像素红雀 (Cardinal)
            { id: 'cardinal', name: '红雀', color: '#BF616A', svg: '<svg viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><rect x="6" y="2" width="2" height="2"/><rect x="8" y="3" width="2" height="2"/><rect x="5" y="4" width="6" height="4"/><rect x="4" y="8" width="8" height="3"/><rect x="5" y="11" width="2" height="2"/><rect x="9" y="11" width="2" height="2"/><rect x="7" y="5" width="1" height="1"/><rect x="10" y="6" width="1" height="1"/></svg>' },
            // 像素乌鸦 (Crow)
            { id: 'crow', name: '乌鸦', color: '#4C566A', svg: '<svg viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><rect x="6" y="2" width="2" height="2"/><rect x="8" y="3" width="2" height="2"/><rect x="5" y="4" width="6" height="4"/><rect x="4" y="8" width="8" height="3"/><rect x="5" y="11" width="2" height="2"/><rect x="9" y="11" width="2" height="2"/><rect x="7" y="5" width="1" height="1"/><rect x="10" y="6" width="1" height="1"/></svg>' },
            // 像素燕雀 (Finch)
            { id: 'finch', name: '燕雀', color: '#A3BE8C', svg: '<svg viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><rect x="6" y="2" width="2" height="2"/><rect x="8" y="3" width="2" height="2"/><rect x="5" y="4" width="6" height="4"/><rect x="4" y="8" width="8" height="3"/><rect x="5" y="11" width="2" height="2"/><rect x="9" y="11" width="2" height="2"/><rect x="7" y="5" width="1" height="1"/><rect x="10" y="6" width="1" height="1"/></svg>' },
            // 像素猫头鹰 (Owl) - 沿用之前的一个像素猫头鹰
            { id: 'owl', name: '猫头鹰', color: '#D08770', svg: '<svg viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="2" width="10" height="2"/><rect x="2" y="4" width="12" height="8"/><rect x="5" y="6" width="2" height="2"/><rect x="9" y="6" width="2" height="2"/><rect x="7" y="9" width="2" height="1"/></svg>' },
            // 像素鹦鹉 (Parrot)
            { id: 'parrot', name: '鹦鹉', color: '#B48EAD', svg: '<svg viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><rect x="6" y="2" width="2" height="2"/><rect x="8" y="3" width="2" height="2"/><rect x="5" y="4" width="6" height="4"/><rect x="4" y="8" width="8" height="3"/><rect x="5" y="11" width="2" height="2"/><rect x="9" y="11" width="2" height="2"/><rect x="7" y="5" width="1" height="1"/><rect x="10" y="6" width="1" height="1"/></svg>' },
            // 像素燕子 (Swallow)
            { id: 'swallow', name: '燕子', color: '#ECEFF4', svg: '<svg viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><rect x="6" y="2" width="2" height="2"/><rect x="8" y="3" width="2" height="2"/><rect x="5" y="4" width="6" height="4"/><rect x="4" y="8" width="8" height="3"/><rect x="5" y="11" width="2" height="2"/><rect x="9" y="11" width="2" height="2"/><rect x="7" y="5" width="1" height="1"/><rect x="10" y="6" width="1" height="1"/></svg>' },
        ];

        let selectedAvatarId = AVATAR_OPTIONS[0].id; // 默认选中第一个
        
        /**
         * 辅助函数：通过 ID 查找头像对象
         */
        function getAvatarById(id) {
            return AVATAR_OPTIONS.find(a => a.id === id) || AVATAR_OPTIONS[0];
        }

        /**
         * 初始化并渲染当前选中的头像
         */
        function initAvatar() {
            // 从 localStorage 加载上次选中的头像 ID
            const storedId = localStorage.getItem(AVATAR_KEY);
            if (storedId && getAvatarById(storedId)) {
                selectedAvatarId = storedId;
            } else {
                // 如果没有存储或存储无效，使用默认值并保存
                localStorage.setItem(AVATAR_KEY, selectedAvatarId);
            }
            renderCurrentAvatar();
        }

        /**
         * 渲染当前头像到主页面的显示区域
         */
        function renderCurrentAvatar() {
            const avatar = getAvatarById(selectedAvatarId);
            currentAvatarEl.style.backgroundColor = avatar.color;
            currentAvatarEl.innerHTML = avatar.svg;
            
            // 针对特定颜色背景设置 SVG 颜色（使用 CSS 变量）
            if (avatar.id === 'robin' || avatar.id === 'swallow') { // 这些背景较亮，SVG用深色
                currentAvatarEl.style.color = 'var(--color-text-dark)';
            } else { // 其它背景较深，SVG用浅色
                currentAvatarEl.style.color = 'var(--color-text-light)';
            }
        }

        /**
         * 渲染模态框中的头像选项
         */
        function renderAvatarOptions() {
            avatarOptionsGridEl.innerHTML = AVATAR_OPTIONS.map(avatar => {
                const isSelected = avatar.id === selectedAvatarId;
                
                // 针对特定颜色背景设置 SVG 颜色
                const svgColorStyle = (avatar.id === 'robin' || avatar.id === 'swallow') ? 'color: var(--color-text-dark);' : 'color: var(--color-text-light);';
                const ringClass = isSelected ? 'selected' : '';

                return `
                    <div 
                        class="avatar-option avatar-svg rounded-full flex items-center justify-center ${ringClass}" 
                        style="background-color: ${avatar.color}; ${svgColorStyle}"
                        data-id="${avatar.id}"
                        onclick="selectAvatar('${avatar.id}')"
                        title="${avatar.name}"
                    >
                        ${avatar.svg}
                    </div>
                `;
            }).join('');
        }

        /**
         * 选择并保存新头像
         */
        function selectAvatar(id) {
            selectedAvatarId = id;
            localStorage.setItem(AVATAR_KEY, id);
            renderCurrentAvatar();
            renderAvatarOptions(); // 重新渲染模态框以更新选中状态
        }

        /**
         * 显示头像选择模态框
         */
        function showAvatarModal() {
            renderAvatarOptions();
            avatarModalEl.classList.remove('hidden');
        }

        /**
         * 隐藏头像选择模态框
         */
        function hideAvatarModal() {
            avatarModalEl.classList.add('hidden');
        }


        /**
         * 填充默认标签到 datalist
         */
        function populateDefaultTags() {
            defaultTagsDatalistEl.innerHTML = DEFAULT_TAGS
                .map(tag => `<option value="${tag}">`)
                .join('');
        }

        /**
         * 检查口令并解锁内容
         */
        function checkPasscode() {
            const enteredPasscode = passcodeInputEl.value.trim();
            if (enteredPasscode === CORRECT_PASSCODE) {
                // 正确口令：隐藏覆盖层，显示主内容
                passcodeOverlayEl.style.opacity = '0';
                setTimeout(() => {
                    passcodeOverlayEl.classList.add('hidden');
                    mainContentEl.classList.remove('hidden');
                    // 渲染内容
                    initAvatar(); // 初始化头像
                    renderThoughts();
                }, 300); // 匹配 CSS 过渡时间
            } else {
                // 错误口令：显示错误信息
                passcodeErrorEl.classList.remove('opacity-0');
                setTimeout(() => {
                    passcodeErrorEl.classList.add('opacity-0');
                }, 2000);
            }
        }
        
        /**
         * 加载想法列表 (从 localStorage)
         */
        function loadThoughts() {
            try {
                const json = localStorage.getItem(STORAGE_KEY);
                // 确保返回数组，并在需要时处理旧数据格式
                const data = json ? JSON.parse(json) : [];
                return Array.isArray(data) ? data : [];
            } catch (e) {
                console.error("加载想法失败:", e);
                return [];
            }
        }

        /**
         * 保存想法列表 (到 localStorage)
         */
        function saveThoughts(thoughts) {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(thoughts));
            } catch (e) {
                console.error("保存想法失败:", e);
            }
        }

        /**
         * 渲染单个想法卡片
         */
        function createThoughtCard(thought) {
            const date = new Date(thought.timestamp).toLocaleString('zh-CN', {
                year: 'numeric', month: '2-digit', day: '2-digit',
                hour: '2-digit', minute: '2-digit'
            });

            // 获取想法关联的头像
            const avatar = getAvatarById(thought.avatarId);

            // 针对特定颜色背景设置 SVG 颜色
            const svgColorStyle = (avatar.id === 'robin' || avatar.id === 'swallow') ? 'color: var(--color-text-dark);' : 'color: var(--color-text-light);';

            // 渲染标签元素
            const tagElements = (thought.tags || [])
                // 想法卡片内的标签样式保持简约
                .map(tag => `<span onclick="filterThoughts('${tag.replace(/'/g, "\\'")}')" class="cursor-pointer px-2 py-0.5 text-xs rounded-full bg-blue-100 text-blue-600 hover:bg-blue-200 transition">#${tag}</span>`)
                .join('');

            return `
                <div id="card-${thought.id}" class="thought-card bg-white p-6 rounded-lg shadow-sm border-l-4 border-gray-300 transition duration-150 ease-in-out hover:shadow-md" style="border-left-color: var(--color-accent);">
                    <div class="flex items-start space-x-4">
                        <!-- Avatar Display --><div 
                            class="avatar-svg flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center p-1" 
                            style="background-color: ${avatar.color}; ${svgColorStyle}"
                            title="${avatar.name}"
                        >
                            ${avatar.svg}
                        </div>
                        
                        <!-- Thought Content --><div class="flex-grow text-base whitespace-pre-wrap">${thought.text}</div>
                    </div>

                    <!-- 标签区块 --><div class="flex flex-wrap gap-2 mt-3 mb-4 pl-12">
                        ${tagElements}
                    </div>

                    <div class="mt-4 flex justify-between items-center border-t pt-3" style="border-color: var(--color-border);">
                        <span class="text-xs text-gray-500">${date}</span>
                        <button 
                            onclick="deleteThought('${thought.id}')"
                            class="text-red-400 hover:text-red-600 transition duration-150 text-sm font-medium"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block align-text-bottom" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                            删除
                        </button>
                    </div>
                </div>
            `;
        }
        
        /**
         * 渲染标签云 (Tag Cloud)
         */
        function renderTagCloud(allThoughts) {
            const tagCounts = {};
            
            // 1. Count user-defined tags
            allThoughts.forEach(thought => {
                // 确保 tags 属性存在且是数组
                const tags = Array.isArray(thought.tags) ? thought.tags : [];
                tags.forEach(tag => {
                    if (typeof tag === 'string' && tag.trim()) {
                        const t = tag.trim();
                        tagCounts[t] = (tagCounts[t] || 0) + 1;
                    }
                });
            });

            // 2. 确保所有默认标签都存在于 tagCounts 中 (即使数量为 0)
            DEFAULT_TAGS.forEach(defaultTag => {
                if (!(defaultTag in tagCounts)) {
                    tagCounts[defaultTag] = 0;
                }
            });

            tagCloudEl.innerHTML = '';
            const allCount = allThoughts.length;

            // 样式定义
            const INACTIVE_TAG_CLASSES = 'bg-gray-100 text-gray-600 border border-gray-300 hover:bg-gray-200';
            const ACTIVE_TAG_CLASSES = 'text-white shadow-lg transform scale-[1.02]'; 

            // '全部' 按钮
            const allButton = document.createElement('button');
            allButton.onclick = () => filterThoughts(null);
            const allIsActive = currentFilterTag === null;
            allButton.className = `px-4 py-1.5 text-sm rounded-full transition duration-200 ease-in-out font-medium tracking-wide ${allIsActive ? ACTIVE_TAG_CLASSES : INACTIVE_TAG_CLASSES}`;
            if (allIsActive) {
                allButton.style.backgroundColor = 'var(--color-accent)';
            }
            allButton.textContent = `全部 (${allCount})`;
            tagCloudEl.appendChild(allButton);


            // 3. 标签按钮排序 (优先数量多的，数量相同则按字母排序)
            const sortedTags = Object.keys(tagCounts).sort((a, b) => {
                const countA = tagCounts[a];
                const countB = tagCounts[b];
                
                // 主要排序: 按数量降序
                if (countA !== countB) {
                    return countB - countA;
                }
                // 次要排序: 按字母升序
                return a.localeCompare(b, 'zh');
            });

            sortedTags.forEach(tag => {
                const count = tagCounts[tag];
                // 如果计数大于 0，则显示 (数量)；否则只显示标签名称
                const buttonText = count > 0 ? `${tag} (${count})` : tag;
                
                const isActive = currentFilterTag === tag;
                const tagButton = document.createElement('button');
                tagButton.onclick = () => filterThoughts(tag);
                tagButton.className = `px-4 py-1.5 text-sm rounded-full transition duration-200 ease-in-out font-medium tracking-wide ${isActive ? ACTIVE_TAG_CLASSES : INACTIVE_TAG_CLASSES}`;
                
                // 使用 style 属性设置强调色，以利用 CSS 变量
                if (isActive) {
                    tagButton.style.backgroundColor = 'var(--color-accent)';
                } else {
                    // 非活动状态下的悬停效果
                    tagButton.classList.add('hover:shadow-sm'); 
                }

                tagButton.textContent = buttonText;
                tagCloudEl.appendChild(tagButton);
            });
        }

        /**
         * 筛选想法列表
         */
        function filterThoughts(tag) {
            currentFilterTag = tag;
            const allThoughts = loadThoughts();
            let thoughtsToRender = allThoughts;

            if (tag) {
                // 仅筛选包含目标标签的想法
                thoughtsToRender = allThoughts.filter(thought => 
                    // 确保 tags 存在且是数组，然后检查是否包含标签
                    (Array.isArray(thought.tags) && thought.tags.includes(tag))
                );
            }
            
            // 重新渲染标签云和列表
            renderTagCloud(allThoughts); 
            renderThoughtList(thoughtsToRender);
        }

        /**
         * 渲染主列表
         */
        function renderThoughtList(thoughts) {
            thoughtsListEl.innerHTML = '';
            
            // --- 更新区域标题以显示分类集信息 ---
            if (currentFilterTag) {
                thoughtsTitleEl.textContent = `分类集: #${currentFilterTag} (${thoughts.length} 条)`;
            } else {
                thoughtsTitleEl.textContent = `全部思绪 (${thoughts.length} 条)`;
            }
            // ------------------------------------

            // 新的想法放在最前面
            const reversedThoughts = [...thoughts].reverse(); 
            
            if (reversedThoughts.length === 0) {
                 thoughtsListEl.innerHTML = `
                    <div class="p-8 text-center text-gray-400">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mx-auto mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v12a1 1 0 01-1 1h-3l-4 4v-4H4a1 1 0 01-1-1V4z" />
                        </svg>
                        ${currentFilterTag ? `没有找到带有 #${currentFilterTag} 标签的思绪。` : '还没有任何思绪。开始记录吧!'}
                    </div>
                `; 
            } else {
                thoughtsListEl.innerHTML = reversedThoughts.map(createThoughtCard).join('');
            }
        }
        
        /**
         * 添加新的想法
         */
        function addThought() {
            const text = thoughtInputEl.value.trim();
            if (!text) {
                // 使用自定义模态框或简单地返回，不要使用 alert()
                console.warn("想法内容不能为空。"); 
                return;
            }

            const tagsText = tagInputEl.value.trim();
            const tags = tagsText ? tagsText.split(',').map(tag => tag.trim()).filter(tag => tag) : [];
            
            const newThought = {
                id: Date.now().toString(), // 简单ID
                text: text,
                tags: tags,
                timestamp: Date.now(),
                avatarId: selectedAvatarId // 使用当前选中的头像 ID
            };

            const thoughts = loadThoughts();
            thoughts.push(newThought);
            saveThoughts(thoughts);

            // 清空输入框
            thoughtInputEl.value = '';
            tagInputEl.value = '';

            // 重新渲染，保持当前筛选状态
            renderThoughts();
        }

        /**
         * 删除想法
         */
        function deleteThought(id) {
            // 在实际应用中，这里应该有一个确认对话框
            const thoughts = loadThoughts();
            const filteredThoughts = thoughts.filter(t => t.id !== id);
            saveThoughts(filteredThoughts);
            
            // 重新渲染，保持当前筛选状态
            renderThoughts();
        }

        /**
         * 主渲染函数：加载数据并根据当前筛选状态渲染列表和标签云
         */
        function renderThoughts() {
            const allThoughts = loadThoughts();
            let thoughtsToRender = allThoughts;

            // 根据当前筛选标签过滤
            if (currentFilterTag) {
                thoughtsToRender = allThoughts.filter(thought => 
                    (Array.isArray(thought.tags) && thought.tags.includes(currentFilterTag))
                );
            }

            // 1. 渲染标签云 (需要所有想法来计算计数)
            renderTagCloud(allThoughts);

            // 2. 渲染想法列表 (渲染过滤后的列表)
            renderThoughtList(thoughtsToRender);
        }

        /**
         * 初始化函数 (在页面加载后执行)
         */
        function init() {
            // 填充默认标签到 datalist
            populateDefaultTags();
            
            // 页面加载后等待用户输入口令，不需要在此处调用 renderThoughts
        }

        // 绑定 Enter 键事件到输入框 (可选，但常用)
        thoughtInputEl.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault(); // 阻止默认换行行为
                addThought();
            }
        });

        // 页面加载后启动初始化
        init();
    </script>
</body>
</html>
